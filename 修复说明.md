# 容器访问问题修复说明

## 问题分析

根据容器状态，发现以下问题：

### 1. FileBot 不断重启
**错误信息**: `ubuntu is not in the sudoers file`
**原因**: FileBot 镜像的用户权限配置与我们的设置冲突
**解决方案**: 暂时禁用 FileBot，需要单独配置

### 2. 多个容器健康检查失败
**失败容器**: 1panel, aipan, lucky, music-tag-web, quark-auto-save, xiaomusic
**原因**: 
- 健康检查命令使用了 `wget` 或 `curl`，但容器内可能没有这些工具
- 启动时间不足，健康检查过早执行
- 某些服务的健康检查端点不正确

## 已应用的修复

### 1. FileBot - 暂时禁用
```yaml
# 已注释掉 FileBot 配置
# 需要单独研究该镜像的正确配置方式
```

### 2. 健康检查优化 - 使用 netcat (nc)
将所有健康检查改为使用 `nc`（netcat），这是更通用的网络工具：

```yaml
healthcheck:
  test: ["CMD-SHELL", "nc -z localhost PORT || exit 1"]
  interval: 30s
  timeout: 10s
  retries: 5
  start_period: 60s-90s  # 增加启动等待时间
```

**优势**:
- `nc` 在大多数容器中都可用
- 只检查端口是否开放，不依赖 HTTP 响应
- 更轻量，更可靠

### 3. 具体容器修复

#### 1Panel
```yaml
healthcheck:
  test: ["CMD-SHELL", "curl -f http://localhost:8888/api/v1/entrance/status || exit 1"]
  start_period: 90s  # 增加到 90 秒
  retries: 5
```

#### Lucky
```yaml
healthcheck:
  test: ["CMD-SHELL", "nc -z localhost 9000 || exit 1"]
  start_period: 90s
  retries: 5
```

#### Music-tag-Web
```yaml
healthcheck:
  test: ["CMD-SHELL", "nc -z localhost 80 || exit 1"]
  start_period: 60s
  retries: 5
```

#### Quark-auto-save
```yaml
healthcheck:
  test: ["CMD-SHELL", "nc -z localhost 5005 || exit 1"]
  start_period: 60s
  retries: 5
```

#### Xiaomusic
```yaml
healthcheck:
  test: ["CMD-SHELL", "nc -z localhost 8090 || exit 1"]
  start_period: 60s
  retries: 5
```

#### Aipan
```yaml
healthcheck:
  test: ["CMD-SHELL", "nc -z localhost 3000 || exit 1"]
  start_period: 90s  # 依赖数据库，需要更长启动时间
  retries: 5
environment:
  - LOG_LEVEL=info  # 从 debug 改为 info，减少日志量
```

## 重启步骤

```bash
# 1. 停止所有容器
docker-compose down

# 2. 启动容器
docker-compose up -d

# 3. 等待 2-3 分钟让所有容器完成启动

# 4. 检查状态
docker-compose ps

# 5. 查看健康状态
docker ps --format "table {{.Names}}\t{{.Status}}"
```

## 预期结果

执行修复后，应该看到：
- ✅ FileBot 不再出现（已禁用）
- ✅ 所有其他容器状态为 `Up` 且健康检查通过（healthy）
- ✅ 1Panel 可以通过 http://localhost:8888 访问
- ✅ 其他服务可以正常访问

## 如果仍有问题

### 检查容器日志
```bash
# 查看特定容器日志
docker-compose logs -f [容器名]

# 例如查看 1panel
docker-compose logs -f 1panel
```

### 手动测试端口
```bash
# 测试端口是否开放
nc -zv localhost 8888  # 1Panel
nc -zv localhost 9001  # Lucky
nc -zv localhost 3002  # Music-tag-Web
nc -zv localhost 5005  # Quark-auto-save
nc -zv localhost 58090 # Xiaomusic
nc -zv localhost 8082  # Aipan
```

### 进入容器检查
```bash
# 进入容器
docker exec -it [容器名] sh

# 检查进程
ps aux

# 检查端口
netstat -tulpn
```

## FileBot 单独配置（可选）

如果需要使用 FileBot，建议：

1. **使用官方推荐配置**
```yaml
filebot:
  image: rednoah/filebot:latest
  container_name: filebot
  environment:
    - PUID=1000
    - PGID=1000
  volumes:
    - ./media/raw:/input
    - ./media/organized:/output
    - ./filebot/config:/config
  # 不使用 command，让容器自行管理
  restart: unless-stopped
```

2. **或使用 jlesage/filebot 镜像**（更稳定）
```yaml
filebot:
  image: jlesage/filebot:latest
  container_name: filebot
  environment:
    - USER_ID=1000
    - GROUP_ID=1000
  volumes:
    - ./filebot/config:/config
    - ./media/raw:/storage
    - ./media/organized:/output
  ports:
    - "5800:5800"  # Web UI
  restart: unless-stopped
```

## 网络子网配置说明

配置中的网络子网 `172.20.0.0/16` 需要替换为实际的子网地址，例如：
```yaml
networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

如果不需要固定子网，可以删除 ipam 配置，让 Docker 自动分配。