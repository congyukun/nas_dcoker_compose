# 容器访问问题排查指南

## 已优化的配置项

### 1. 端口映射规范化
所有端口映射已统一使用引号格式，避免 YAML 解析问题：
```yaml
ports:
  - "8888:8888"  # 正确格式
```

### 2. 健康检查优化
为所有 Web 服务添加了健康检查，使用 `wget` 替代 `curl`（更轻量）：
```yaml
healthcheck:
  test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:PORT/ || exit 1"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 30s-60s
```

### 3. 网络配置增强
为 `app-network` 添加了子网配置，确保容器间通信稳定：
```yaml
networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

### 4. 关键修复点

#### 1Panel (端口 8888)
- ✅ 添加缺失的端口映射 `8888:8888`
- ✅ 修改 restart 策略为 `unless-stopped`
- ✅ 添加健康检查

#### FileBot
- ✅ 增加 JAVA 内存到 1024m
- ✅ 修改用户权限为 `1000:1000`（与其他容器一致）
- ✅ 添加 `start_period` 避免启动时健康检查失败

#### Xiaomusic
- ✅ 添加 TZ 环境变量
- ✅ 规范化端口映射格式
- ✅ 添加健康检查

## 容器访问测试步骤

### 1. 验证配置
```bash
docker-compose config
```

### 2. 重启所有容器
```bash
docker-compose down
docker-compose up -d
```

### 3. 检查容器状态
```bash
docker-compose ps
```

### 4. 查看健康状态
```bash
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

### 5. 测试端口访问
```bash
# 测试 1Panel
curl -I http://localhost:8888

# 测试 Navidrome
curl -I http://localhost:4533

# 测试 Music-tag-Web
curl -I http://localhost:3002

# 测试 Quark-auto-save
curl -I http://localhost:5005

# 测试 Lucky
curl -I http://localhost:9001

# 测试 Xiaomusic
curl -I http://localhost:58090

# 测试 Jackett
curl -I http://localhost:9117
```

### 6. 查看容器日志
如果某个容器无法访问，查看其日志：
```bash
docker-compose logs -f [容器名]
```

## 常见问题排查

### 问题 1: 容器启动但无法访问
**可能原因：**
- 端口被占用
- 防火墙阻止
- 容器内服务未正常启动

**排查步骤：**
```bash
# 检查端口占用
netstat -tulpn | grep [端口号]

# 检查容器日志
docker logs [容器名]

# 进入容器检查
docker exec -it [容器名] sh
```

### 问题 2: 健康检查失败
**可能原因：**
- 启动时间过长
- 健康检查命令不正确
- 容器内缺少检查工具

**解决方案：**
```yaml
healthcheck:
  start_period: 60s  # 增加启动等待时间
  retries: 5         # 增加重试次数
```

### 问题 3: 容器间无法通信
**可能原因：**
- 网络配置问题
- 容器名解析失败

**解决方案：**
```bash
# 检查网络
docker network inspect nas_dcoker_compose_app-network

# 测试容器间连接
docker exec [容器A] ping [容器B]
```

### 问题 4: 权限问题
**可能原因：**
- PUID/PGID 不匹配
- 挂载目录权限不足

**解决方案：**
```bash
# 检查目录权限
ls -la /vol2/1000/

# 修改权限
sudo chown -R 1000:1000 /vol2/1000/media
sudo chown -R 1000:1000 /vol2/1000/music
```

## 各容器访问地址

| 服务 | 端口 | 访问地址 | 说明 |
|------|------|---------|------|
| Qbittorrent | 8080 | http://localhost:8080 | 下载器 |
| MoviePilot-v2 | 3000 | http://localhost:3000 | 影视自动化 |
| Nastools | 3001 | http://localhost:3001 | 备选自动化 |
| Jellyfin | 8096 | http://localhost:8096 | 媒体服务器 |
| Navidrome | 4533 | http://localhost:4533 | 音乐服务器 |
| Music-tag-Web | 3002 | http://localhost:3002 | 音乐标签编辑 |
| Quark-auto-save | 5005 | http://localhost:5005 | 夸克转存 |
| 1Panel | 8888 | http://localhost:8888 | 管理面板 |
| Lucky | 9001 | http://localhost:9001 | 全能面板 |
| Aipan | 8082 | http://localhost:8082 | 网盘搜索 |
| Xiaomusic | 58090 | http://localhost:58090 | 小爱音乐 |
| Jackett | 9117 | http://localhost:9117 | 索引器 |

## 性能优化建议

### 1. 资源监控
```bash
# 查看容器资源使用
docker stats

# 查看特定容器
docker stats [容器名]
```

### 2. 日志管理
```bash
# 限制日志大小（在 docker-compose.yaml 中添加）
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

### 3. 定期清理
```bash
# 清理未使用的镜像
docker image prune -a

# 清理未使用的卷
docker volume prune

# 清理未使用的网络
docker network prune
```

## 备份建议

### 重要配置目录
```bash
# 备份配置
tar -czf backup-$(date +%Y%m%d).tar.gz \
  ./data/ \
  ./qbittorrent/config/ \
  ./moviepilot/config/ \
  ./nastools/config/ \
  ./jellyfin/config/ \
  ./navidrome/data/ \
  docker-compose.yaml
```

### 恢复配置
```bash
# 解压备份
tar -xzf backup-YYYYMMDD.tar.gz

# 重启容器
docker-compose up -d